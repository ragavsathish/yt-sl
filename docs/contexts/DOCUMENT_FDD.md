# Document Context

> Generates Markdown documents from extracted slides and transcripts.

---

## Table of Contents

1. [Responsibility](#responsibility)
2. [Domain Types](#domain-types)
3. [Handlers](#handlers)
4. [Policies](#policies)
5. [External Dependencies](#external-dependencies)
6. [Testing](#testing)

---

## Responsibility

The Document Context is responsible for:

- **Generating** Markdown documents from slides and transcripts
- **Embedding** slide images as base64 or relative paths
- **Including** timestamps in output
- **Formatting** content with Markdown syntax
- **Prompting** for deletion of tagged slides

---

## Domain Types

### MarkdownDocument

Represents a generated Markdown document.

**Fields:**
- id - Unique document identifier
- session_id - Associated session identifier
- title - Document title (video title)
- path - File system path
- slide_count - Number of slides in document
- generated_at - Generation timestamp

### DocumentTemplate

Template for Markdown document generation.

**Fields:**
- header_template - Document header section
- slide_template - Individual slide section
- transcript_template - Transcript section
- footer_template - Document footer section

---

## Handlers

### Generate Markdown

Generates Markdown document from slides and transcript.

**Input:** GenerateMarkdownCommand
- session_id - Session to generate document for

**Output:** MarkdownGenerated event
- session_id - Session identifier
- path - Generated document path
- slide_count - Number of slides

**Behavior:**
- Retrieves all slides for session
- Retrieves transcript if available
- Applies template to generate content
- Embeds slide images
- Writes document to file system
- Returns error on generation failure

---

## Policies

### Document Structure

Standard Markdown document structure:

1. **Header**
   - Title (video title)
   - Source URL
   - Generation timestamp
   - Slide count

2. **Slides Section**
   - Each slide as separate section
   - Slide number
   - Timestamp (if enabled)
   - Image (embedded or linked)
   - Extracted text (if available)
   - Confidence score (if available)

3. **Transcript Section** (optional)
   - Full transcript text
   - Timestamped segments
   - Language indicator

4. **Footer**
   - Generated by tag
   - Tool version
   - Summary statistics

---

### Image Embedding

Embeds slide images in Markdown.

**Options:**

1. **Base64 Embedding** (default)
   - Images encoded as base64 data URIs
   - Single self-contained Markdown file
   - Larger file size
   - Works offline

2. **Relative Path Linking**
   - Images saved as separate files
   - Markdown contains relative paths
   - Smaller Markdown file
   - Requires image files

**Configuration:**
- `--embed-images` - Embed images as base64 (default)
- `--link-images` - Link to image files instead

**Naming Convention:** `slide_<number>.png`

### Timestamp Format

Formats timestamps in document.

**Options:**

1. **HH:MM:SS** (default)
   - Format: `Slide 1 (00:00:15)`

2. **Seconds**
   - Format: `Slide 1 (15s)`

3. **No Timestamps**
   - Format: `Slide 1`

**Configuration:**
- `--timestamps` - Include timestamps (default: true)
- `--timestamp-format` - Timestamp format (default: hh:mm:ss)

### Text Inclusion

Includes extracted text in document.

**Options:**

1. **Always Include**
   - Include all extracted text
   - Mark low confidence text

2. **High Confidence Only**
   - Only include text above threshold
   - Default threshold: 0.8

3. **Exclude Text**
   - Don't include any text
   - Only images

**Configuration:**
- `--include-text` - Include extracted text (default: true)
- `--min-text-confidence` - Minimum confidence for text (default: 0.0)

---

## External Dependencies

### MarkdownGenerator

Generates Markdown content from slides.

**Signature:**
- `generate(&session_id, &slides, &transcript) -> Result<(path, slide_count), error>`

**Implementation:** TeraMarkdownGenerator
- Uses Tera templating engine
- Applies template to slide data
- Embeds images or links to files
- Writes document to file system

### Template Engine

Uses Tera for templating:

**Features:**
- Variable substitution
- Conditionals (include/exclude sections)
- Loops (iterate over slides)
- Filters (format timestamps, etc.)

**Default Template:** Embedded in binary

**Custom Templates:**
- Can specify custom template file
- `--template <path>` CLI flag
- Must follow Tera syntax

---

## Testing

### Unit Tests

Test template rendering:
- Verify header template renders correctly
- Verify slide template renders correctly
- Verify footer template renders correctly
- Test conditional sections

Test image embedding:
- Verify base64 encoding works
- Verify relative path linking works
- Test with missing images

Test timestamp formatting:
- Verify HH:MM:SS format
- Verify seconds format
- Verify no timestamps option

### Integration Tests

Test document generation:
- Generate document from sample slides
- Verify all slides included
- Verify timestamps correct
- Verify images embedded correctly

Test transcript inclusion:
- Generate document with transcript
- Verify transcript included
- Verify segments included
- Test without transcript

### Mock Dependencies

**MockMarkdownGenerator:**
- Returns mock document content
- Simulates generation delay
- Can simulate generation failures

---

## Implementation Notes

### Template Engine Integration

Uses Tera templating engine:

**Default Template:**
```tera
# {{ title }}

**Source:** {{ video_url }}
**Generated:** {{ generated_at }}
**Slides:** {{ slide_count }}

{% for slide in slides %}
## Slide {{ loop.index }}{% if include_timestamps %} ({{ slide.timestamp }}){% endif %}

{% if slide.image_embedded %}
![Slide {{ loop.index }}]({{ slide.image_base64 }})
{% else %}
![Slide {{ loop.index }}]({{ slide.image_path }})
{% endif %}

{% if slide.extracted_text and slide.ocr_confidence >= min_text_confidence %}
### Extracted Text

{{ slide.extracted_text }}

*Confidence: {{ slide.ocr_confidence | round(2) }}*
{% endif %}

{% if slide.requires_human_review %}
> **Note:** This slide was flagged as potentially not containing presentation content. Manual review recommended.
{% endif %}

{% endfor %}

{% if transcript %}
## Transcript

### Full Text

{{ transcript.text }}

### Segments

{% for segment in transcript.segments %}
**{{ segment.start_time }}:** {{ segment.text }}

{% endfor %}
{% endif %}

---

*Generated by yt-sl v{{ version }}*
```

### Image Processing

For base64 embedding:
1. Read image file as bytes
2. Encode as base64 string
3. Construct data URI: `data:image/png;base64,<encoded_data>`
4. Embed in Markdown image syntax

For relative path linking:
1. Copy image to output directory
2. Generate filename: `slide_<number>.png`
3. Use relative path in Markdown: `![Slide](slide_1.png)`

### File Output

Writes document to output directory:

**Output Filename:** `<video_title>_slides.md`

**Output Directory:** Configurable (default: current directory)

**Error Handling:**
- Check if directory writable
- Check if filename conflicts
- Create backup if file exists
- Fail if write permission denied

---

## Error Handling

### Generation Failures

**Causes:**
- Template rendering error
- Image embedding failure
- File write error
- Insufficient disk space
- Permission errors

**Handling:**
- Log error with details
- Return MarkdownGenerationFailed error
- Mark session as failed
- Cleanup partial files

### Template Errors

**Causes:**
- Invalid template syntax
- Missing template variables
- Invalid filters
- Rendering errors

**Handling:**
- Log error with template details
- Return TemplateError error
- Use fallback template if available
- Fail if no fallback available

### Image Processing Failures

**Causes:**
- Image file not found
- Invalid image format
- Base64 encoding failure
- Memory allocation error

**Handling:**
- Log error with image details
- Skip image embedding
- Continue with text-only document
- Warn user about missing images

---

## User Experience

### Document Output

Generates user-friendly Markdown:

**Features:**
- Table of contents (optional)
- Clear slide separation
- Readable timestamps
- High-contrast text
- Responsive images

**Options:**
- `--include-toc` - Add table of contents
- `--toc-depth` - TOC heading depth (default: 2)

### File Organization

Organizes output files:

**With base64 embedding:**
- Single Markdown file
- No additional files

**With relative path linking:**
- Markdown file
- `images/` directory with slide images
- Images named: `slide_1.png`, `slide_2.png`, etc.

### Post-Generation Actions

Actions after document generation:

1. **Summary Report**
   - Document path
   - Slide count
   - Transcript included (yes/no)
   - File size

2. **Tagged Slide Cleanup Prompt**
   - Count slides requiring human review
   - Prompt for deletion
   - Delete or keep based on user input

3. **File Location**
   - Display full path to document
   - Show relative path from working directory
   - Suggest opening command

---

## Configuration Options

### Document Configuration

**Parameters:**
- `output_directory` - Output directory (default: current directory)
- `embed_images` - Embed images as base64 (default: true)
- `include_timestamps` - Include slide timestamps (default: true)
- `timestamp_format` - Timestamp format (hh:mm:ss, seconds)
- `include_text` - Include extracted text (default: true)
- `min_text_confidence` - Minimum confidence for text (default: 0.0)
- `include_transcript` - Include transcript if available (default: true)
- `template` - Custom template file path

### CLI Flags

- `--output <path>` - Output directory
- `--embed-images` - Embed images as base64
- `--link-images` - Link to image files
- `--timestamps` - Include timestamps
- `--timestamp-format <format>` - Timestamp format
- `--include-text` - Include extracted text
- `--min-text-confidence <threshold>` - Minimum text confidence
- `--include-transcript` - Include transcript
- `--no-transcript` - Exclude transcript
- `--template <path>` - Custom template file

---

## Customization

### Custom Templates

Users can provide custom templates:

**Template Variables:**
- `title` - Video title
- `video_url` - YouTube URL
- `generated_at` - Generation timestamp
- `slide_count` - Number of slides
- `slides` - Array of slide objects
- `transcript` - Transcript object (optional)
- `version` - Tool version

**Slide Object Fields:**
- `number` - Slide number
- `timestamp` - Slide timestamp
- `image_base64` - Base64-encoded image
- `image_path` - Relative image path
- `extracted_text` - Extracted text
- `ocr_confidence` - OCR confidence
- `requires_human_review` - Human review flag

**Example Custom Template:**
```tera
# {{ title }}

## Slides

{% for slide in slides %}
### Slide {{ slide.number }}

{{ slide.extracted_text }}

![Slide {{ slide.number }}]({{ slide.image_path }})

{% endfor %}
```

### Custom Styling

Users can customize Markdown output:

**Options:**
- Add HTML comments
- Use custom markdown extensions
- Include CSS in HTML output
- Use custom heading styles

**Note:** Markdown renderers may not support all features
